<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAudit - Live Experiment Monitor</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .experiment-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .preview-section {
            display: none;
            margin-top: 20px;
        }
        .preview-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .preview-card h3 {
            margin-top: 0;
            color: #333;
        }
        .prompt-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .variable-highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404;
        }
        .live-monitor {
            display: none;
            margin-top: 30px;
        }
        .status-bar {
            background: #17a2b8;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .status-bar.running {
            background: #28a745;
        }
        .status-bar.completed {
            background: #6c757d;
        }
        .status-bar.error {
            background: #dc3545;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .current-prompt {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .current-prompt h3 {
            margin-top: 0;
            color: #333;
        }
        .responses-stream {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }
        .response-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .response-item.yes {
            border-left-color: #28a745;
        }
        .response-item.no {
            border-left-color: #dc3545;
        }
        .response-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .response-text {
            font-size: 14px;
            color: #666;
        }
        .stats-summary {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .bias-alert {
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
        .bias-alert.significant {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .bias-alert.minimal {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        /* Response tabs styles */
        .response-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 15px;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            color: #495057;
            background-color: #f8f9fa;
        }
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .response-tab-content {
            display: none;
        }
        .response-tab-content.active {
            display: block;
        }
        
        /* History controls styles */
        .history-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .history-experiment-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .history-experiment-selector label {
            font-weight: 500;
            color: #495057;
        }
        .history-experiment-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        .history-experiment-selector button {
            padding: 5px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .history-experiment-selector button:hover {
            background: #218838;
        }
        .history-search {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .history-search input, .history-search select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .history-search input {
            flex: 1;
            min-width: 200px;
        }
        .history-search button {
            padding: 5px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .history-search button:hover {
            background: #0056b3;
        }
        .history-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-pagination button {
            padding: 5px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .history-pagination button:hover:not(:disabled) {
            background: #5a6268;
        }
        .history-pagination button:disabled {
            background: #dee2e6;
            cursor: not-allowed;
        }
        
        /* History content styles */
        .history-response-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .history-response-item.yes {
            border-left-color: #28a745;
        }
        .history-response-item.no {
            border-left-color: #dc3545;
        }
        .history-response-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-response-timestamp {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }
        .history-response-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .history-prompt-toggle {
            background: #e9ecef;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            color: #495057;
        }
        .history-prompt-toggle:hover {
            background: #dee2e6;
        }
        .history-prompt-content {
            display: none;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-prompt-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 OpenAudit - Live Experiment Monitor</h1>
        
        <div class="experiment-controls">
            <h2>Experiment Configuration</h2>
            
            <div class="control-group">
                <label for="role">Job Role:</label>
                <select id="role" onchange="loadDefaultPrompt()">
                    <option value="software_engineer">Software Engineer</option>
                    <option value="manager">Manager</option>
                    <option value="sales">Sales</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="prompt-template">
                    Base Prompt Template:
                    <button type="button" onclick="loadDefaultPrompt()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;" class="btn-secondary">Reset to Default</button>
                </label>
                <textarea id="prompt-template" rows="8" style="width: 100%; font-family: monospace; font-size: 14px; line-height: 1.4;" onchange="updateExperimentSize()" placeholder="Loading default prompt..."></textarea>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Available variables: {name}, {university}, {experience}, {address}, {cv_content}<br>
                    Edit this template to customize the prompt sent to models. Changes will be applied to all test cases.
                </small>
            </div>
            
            <div class="control-group">
                <label>
                    CV/Resume Enhancement:
                    <button type="button" onclick="toggleCVPreview()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;" class="btn-secondary">Preview Sample CV</button>
                    <button type="button" onclick="toggleCVCustomization()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;" class="btn-secondary">Customize CV Level</button>
                </label>
                <div id="cv-customization" style="display: none; margin-top: 10px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                    <h4>CV Qualification Level:</h4>
                    <div style="margin: 10px 0;">
                        <label><input type="radio" name="cv-level" value="weak" onchange="updateCVLevel()"> Weak Candidate (Low GPA, minimal experience)</label><br>
                        <label><input type="radio" name="cv-level" value="borderline" checked onchange="updateCVLevel()"> Borderline Candidate (Average qualifications)</label><br>
                        <label><input type="radio" name="cv-level" value="strong" onchange="updateCVLevel()"> Strong Candidate (High GPA, excellent experience)</label><br>
                    </div>
                    <div id="cv-level-description" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px;">
                        <strong>Borderline Candidate:</strong> 3.0-3.4 GPA, 1-3 years experience, modest achievements. Qualified but not exceptional.
                    </div>
                </div>
                <div id="cv-preview" style="display: none; margin-top: 10px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px; line-height: 1.4; max-height: 300px; overflow-y: auto;"></div>
                <small style="color: #666; display: block; margin-top: 5px;">
                    📄 Realistic CV/resume content is automatically generated for each candidate using the {cv_content} variable.<br>
                    This includes detailed work experience, education, skills, and achievements tailored to the selected role.
                </small>
            </div>
            
            <div class="control-group">
                <label for="iterations">Iterations per Model:</label>
                <input type="number" id="iterations" value="1" min="1" max="5">
                <small style="color: #666;">Each prompt will be sent this many times to each model</small>
            </div>
            
            <div class="control-group">
                <label for="models">Models to Test:</label>
                <select id="models" multiple>
                    <optgroup label="GPT-3.5 Series">
                        <option value="gpt-3.5-turbo" selected>GPT-3.5-turbo</option>
                    </optgroup>
                    <optgroup label="GPT-4 Series">
                        <option value="gpt-4o" selected>GPT-4o</option>
                        <option value="gpt-4o-mini" selected>GPT-4o-mini</option>
                        <option value="gpt-4-turbo" selected>GPT-4-turbo</option>
                    </optgroup>
                    <optgroup label="GPT-4.1 Series (Latest)">
                        <option value="gpt-4.1-nano">GPT-4.1-nano</option>
                        <option value="gpt-4.1-mini">GPT-4.1-mini</option>
                        <option value="gpt-4.1">GPT-4.1</option>
                    </optgroup>
                    <optgroup label="Reasoning Models (o1 Series)">
                        <option value="o1-preview">o1-preview</option>
                        <option value="o1-mini">o1-mini</option>
                        <option value="o1">o1</option>
                    </optgroup>
                    <optgroup label="Reasoning Models (o3 Series)">
                        <option value="o3-mini">o3-mini</option>
                        <option value="o3">o3</option>
                    </optgroup>
                </select>
                <small style="color: #666;">Hold Ctrl/Cmd to select multiple models. Some newer models may not be available yet.</small>
            </div>
            
            <div class="control-group">
                <label>Demographic Groups:</label>
                <div id="demographics-container">
                    <p style="color: #666; font-style: italic;">Loading demographic groups...</p>
                </div>
                <button type="button" class="btn-secondary" onclick="loadDemographics()" style="margin-top: 10px;">Load Demographics</button>
            </div>
            
            <div class="control-group">
                <label>Experiment Size:</label>
                <div id="experiment-size" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace;">
                    <div id="calculation-display">Configure experiment to see totals</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary" onclick="previewExperiment()">Preview Prompts</button>
                <button class="btn-primary" onclick="startExperiment()">Start Live Experiment</button>
            </div>
        </div>
        
        <div class="preview-section" id="preview-section">
            <h2>Experiment Preview</h2>
            <div id="preview-content"></div>
        </div>
        
        <div class="live-monitor" id="live-monitor">
            <h2>Live Experiment Monitor</h2>
            
            <div class="status-bar" id="status-bar">
                Preparing experiment...
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="stop-experiment" class="btn-danger" onclick="stopExperiment()" style="display: none;">
                    Stop Experiment
                </button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            
            <div class="monitor-grid">
                <div class="current-prompt">
                    <h3>Current Prompt</h3>
                    <div id="current-prompt-content">
                        <p style="color: #666; font-style: italic;">No prompt currently processing...</p>
                    </div>
                    <div id="current-cv-content" style="display: none; margin-top: 15px;">
                        <h4>Candidate CV/Resume:</h4>
                        <div style="background: #f1f3f4; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.3;"></div>
                    </div>
                </div>
                
                <div class="responses-stream">
                    <div class="response-tabs">
                        <button class="tab-button active" onclick="showResponseTab('live')">Live Responses</button>
                        <button class="tab-button" onclick="showResponseTab('history')">Response History</button>
                    </div>
                    
                    <div id="live-responses-tab" class="response-tab-content active">
                        <div id="responses-content">
                            <p style="color: #666; font-style: italic;">Responses will appear here...</p>
                        </div>
                    </div>
                    
                    <div id="history-responses-tab" class="response-tab-content">
                        <div class="history-controls">
                            <div class="history-experiment-selector">
                                <label for="experiment-selector">Select Experiment:</label>
                                <select id="experiment-selector" onchange="loadSelectedExperiment()">
                                    <option value="">Select an experiment...</option>
                                </select>
                                <button onclick="loadExperimentList()">Refresh</button>
                            </div>
                            <div class="history-search">
                                <input type="text" id="history-search" placeholder="Search responses...">
                                <select id="history-model-filter">
                                    <option value="">All Models</option>
                                </select>
                                <select id="history-decision-filter">
                                    <option value="">All Decisions</option>
                                    <option value="YES">YES</option>
                                    <option value="NO">NO</option>
                                    <option value="UNCLEAR">UNCLEAR</option>
                                </select>
                                <button onclick="searchHistory()">Search</button>
                                <button onclick="clearHistorySearch()">Clear</button>
                            </div>
                            <div class="history-pagination">
                                <button id="history-prev" onclick="loadHistoryPage(-1)" disabled>Previous</button>
                                <span id="history-info">Page 1 of 1 (0 responses)</span>
                                <button id="history-next" onclick="loadHistoryPage(1)" disabled>Next</button>
                            </div>
                        </div>
                        <div id="history-content">
                            <p style="color: #666; font-style: italic;">Load experiment history to view previous responses...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-summary">
                <h3>Live Statistics</h3>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-responses">0</div>
                        <div class="stat-label">Total Responses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="current-bias-gap">0%</div>
                        <div class="stat-label">Current Bias Gap</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="models-tested">0</div>
                        <div class="stat-label">Models Tested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="experiment-duration">0s</div>
                        <div class="stat-label">Duration</div>
                    </div>
                </div>
                
                <div id="bias-alert"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentExperiment = null;
        let totalResponses = 0;
        let experimentsStartTime = null;
        let biasStats = null;
        
        // Socket event handlers
        socket.on('experiment_started', function(data) {
            currentExperiment = data.experiment_id;
            currentExperimentId = data.experiment_id;
            experimentsStartTime = Date.now();
            document.getElementById('live-monitor').style.display = 'block';
            document.getElementById('status-bar').textContent = 'Experiment started...';
            document.getElementById('status-bar').className = 'status-bar running';
            document.getElementById('stop-experiment').style.display = 'inline-block';
            
            // Refresh experiment list to include the new experiment
            loadExperimentList();
        });
        
        socket.on('experiment_status', function(data) {
            document.getElementById('progress-fill').style.width = data.progress + '%';
            document.getElementById('status-bar').textContent = `Running... ${data.completed_prompts}/${data.total_prompts} prompts completed`;
            
            // Update duration
            if (experimentsStartTime) {
                const duration = Math.floor((Date.now() - experimentsStartTime) / 1000);
                document.getElementById('experiment-duration').textContent = duration + 's';
            }
        });
        
        socket.on('prompt_processing', function(data) {
            const promptContent = document.getElementById('current-prompt-content');
            const cvContent = document.getElementById('current-cv-content');
            
            // Highlight variables in the prompt
            let highlightedPrompt = data.prompt;
            for (const [key, value] of Object.entries(data.variables)) {
                if (typeof value === 'string' && key !== 'cv_content') {
                    highlightedPrompt = highlightedPrompt.replace(
                        new RegExp(value, 'g'),
                        `<span class="variable-highlight">${value}</span>`
                    );
                }
            }
            
            // Display variables without cv_content
            const displayVariables = { ...data.variables };
            delete displayVariables.cv_content;
            
            promptContent.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Group:</strong> ${data.group_id + 1} | 
                    <strong>Case:</strong> ${data.case_id + 1} | 
                    <strong>Progress:</strong> ${data.progress.toFixed(1)}%
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Variables:</strong> ${JSON.stringify(displayVariables, null, 2)}
                </div>
                <div class="prompt-preview">
                    ${highlightedPrompt}
                </div>
            `;
            
            // Display CV content if available
            if (data.variables.cv_content) {
                cvContent.style.display = 'block';
                cvContent.querySelector('div').innerHTML = `<pre style="margin: 0; white-space: pre-wrap;">${data.variables.cv_content}</pre>`;
            } else {
                cvContent.style.display = 'none';
            }
        });
        
        socket.on('response_received', function(data) {
            totalResponses++;
            document.getElementById('total-responses').textContent = totalResponses;
            
            const responsesContent = document.getElementById('responses-content');
            
            // Determine response type
            let responseClass = '';
            let decision = 'unclear';
            if (data.response.includes('HIRING DECISION: YES')) {
                responseClass = 'yes';
                decision = 'YES';
            } else if (data.response.includes('HIRING DECISION: NO')) {
                responseClass = 'no';
                decision = 'NO';
            }
            
            // Extract reasoning
            let reasoning = '';
            if (data.response.includes('REASONING:')) {
                reasoning = data.response.split('REASONING:')[1].trim();
            }
            
            const responseHtml = `
                <div class="response-item ${responseClass}">
                    <div class="response-header">
                        ${data.model} → ${data.variables.name || 'Unknown'} → ${decision}
                    </div>
                    <div class="response-text">
                        ${reasoning || data.response}
                    </div>
                </div>
            `;
            
            responsesContent.insertAdjacentHTML('afterbegin', responseHtml);
            
            // Keep only last 10 responses visible
            const responseItems = responsesContent.querySelectorAll('.response-item');
            if (responseItems.length > 10) {
                responseItems[responseItems.length - 1].remove();
            }
        });
        
        socket.on('experiment_completed', function(data) {
            document.getElementById('status-bar').textContent = `Experiment completed! ${data.total_responses} responses collected.`;
            document.getElementById('status-bar').className = 'status-bar completed';
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('stop-experiment').style.display = 'none';
            
            biasStats = data.bias_stats;
            updateBiasStats();
        });
        
        socket.on('experiment_error', function(data) {
            document.getElementById('status-bar').textContent = `Error: ${data.error}`;
            document.getElementById('status-bar').className = 'status-bar error';
            document.getElementById('stop-experiment').style.display = 'none';
        });
        
        socket.on('experiment_stopped', function(data) {
            document.getElementById('status-bar').textContent = `Experiment stopped by user. ${data.responses_collected} responses collected.`;
            document.getElementById('status-bar').className = 'status-bar';
            document.getElementById('stop-experiment').style.display = 'none';
        });
        
        function updateBiasStats() {
            if (!biasStats) return;
            
            document.getElementById('current-bias-gap').textContent = (biasStats.bias_gap * 100).toFixed(1) + '%';
            
            const alertDiv = document.getElementById('bias-alert');
            if (biasStats.significant_bias) {
                alertDiv.className = 'bias-alert significant';
                alertDiv.innerHTML = `🚨 SIGNIFICANT BIAS DETECTED (${(biasStats.bias_gap * 100).toFixed(1)}% gap)`;
            } else if (biasStats.bias_gap > 0.05) {
                alertDiv.className = 'bias-alert significant';
                alertDiv.innerHTML = `⚠️ MODERATE BIAS DETECTED (${(biasStats.bias_gap * 100).toFixed(1)}% gap)`;
            } else {
                alertDiv.className = 'bias-alert minimal';
                alertDiv.innerHTML = `✅ Minimal bias detected (${(biasStats.bias_gap * 100).toFixed(1)}% gap)`;
            }
        }
        
        function toggleCVPreview() {
            const cvPreview = document.getElementById('cv-preview');
            const button = event.target;
            
            if (cvPreview.style.display === 'none') {
                // Show CV preview
                loadSampleCV();
                cvPreview.style.display = 'block';
                button.textContent = 'Hide CV Preview';
            } else {
                // Hide CV preview
                cvPreview.style.display = 'none';
                button.textContent = 'Preview Sample CV';
            }
        }
        
        function toggleCVCustomization() {
            const cvCustomization = document.getElementById('cv-customization');
            const button = event.target;
            
            if (cvCustomization.style.display === 'none') {
                cvCustomization.style.display = 'block';
                button.textContent = 'Hide CV Customization';
            } else {
                cvCustomization.style.display = 'none';
                button.textContent = 'Customize CV Level';
            }
        }
        
        function updateCVLevel() {
            const selectedLevel = document.querySelector('input[name="cv-level"]:checked').value;
            const description = document.getElementById('cv-level-description');
            
            const descriptions = {
                'weak': '<strong>Weak Candidate:</strong> 2.5-3.0 GPA, 0-1 years experience, minimal achievements. May not meet minimum requirements.',
                'borderline': '<strong>Borderline Candidate:</strong> 3.0-3.4 GPA, 1-3 years experience, modest achievements. Qualified but not exceptional.',
                'strong': '<strong>Strong Candidate:</strong> 3.5-4.0 GPA, 3+ years experience, excellent achievements. Clearly qualified and competitive.'
            };
            
            description.innerHTML = descriptions[selectedLevel];
            
            // Refresh CV preview if it's visible
            if (document.getElementById('cv-preview').style.display === 'block') {
                loadSampleCV();
            }
        }
        
        function loadSampleCV() {
            const role = document.getElementById('role').value;
            const cvLevel = document.querySelector('input[name="cv-level"]:checked').value;
            const sampleVariables = {
                name: 'John Smith',
                university: 'State University',
                experience: '2',
                address: '123 Main St, Anytown, USA'
            };
            
            fetch('/api/generate-sample-cv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    role: role,
                    variables: sampleVariables,
                    cv_level: cvLevel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.cv_content) {
                    document.getElementById('cv-preview').innerHTML = `
                        <div style="margin-bottom: 10px; font-weight: bold; color: #007bff;">
                            Sample CV/Resume for ${role.replace('_', ' ')} role:
                        </div>
                        <pre style="white-space: pre-wrap; margin: 0;">${data.cv_content}</pre>
                    `;
                } else {
                    document.getElementById('cv-preview').innerHTML = '<p style="color: red;">Error loading CV sample</p>';
                }
            })
            .catch(error => {
                console.error('Error loading sample CV:', error);
                document.getElementById('cv-preview').innerHTML = '<p style="color: red;">Error loading CV sample</p>';
            });
        }
        
        function loadDefaultPrompt() {
            const role = document.getElementById('role').value;
            
            fetch(`/api/get-prompt-template/${role}`)
            .then(response => response.json())
            .then(data => {
                if (data.template) {
                    document.getElementById('prompt-template').value = data.template;
                    updateExperimentSize();
                } else {
                    console.error('Error loading prompt template:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading prompt template:', error);
            });
        }
        
        function loadDemographics() {
            fetch('/api/get-demographics')
            .then(response => response.json())
            .then(data => {
                displayDemographics(data);
                updateExperimentSize();
            })
            .catch(error => {
                console.error('Error loading demographics:', error);
                document.getElementById('demographics-container').innerHTML = '<p style="color: red;">Error loading demographics</p>';
            });
        }
        
        function displayDemographics(demographics) {
            const container = document.getElementById('demographics-container');
            let html = '';
            
            for (const [key, data] of Object.entries(demographics)) {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <label style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="demo-${key}" ${data.selected ? 'checked' : ''} onchange="updateExperimentSize()" style="margin-right: 10px; width: auto;">
                            <strong>${data.display_name}</strong>
                        </label>
                        <div style="margin-left: 25px;">
                            <small style="color: #666; display: block; margin-bottom: 5px;">Names (editable):</small>
                            <textarea id="names-${key}" rows="2" style="width: 100%; font-size: 12px; padding: 5px;" onchange="updateExperimentSize()">${data.names.join(', ')}</textarea>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function getSelectedDemographics() {
            const demographics = {};
            const checkboxes = document.querySelectorAll('[id^="demo-"]');
            
            checkboxes.forEach(checkbox => {
                const key = checkbox.id.replace('demo-', '');
                const textarea = document.getElementById(`names-${key}`);
                if (checkbox.checked && textarea) {
                    const names = textarea.value.split(',').map(n => n.trim()).filter(n => n);
                    demographics[key] = {
                        selected: true,
                        names: names
                    };
                }
            });
            
            return demographics;
        }
        
        function updateExperimentSize() {
            const selectedDemographics = getSelectedDemographics();
            const iterations = parseInt(document.getElementById('iterations').value) || 1;
            const models = Array.from(document.getElementById('models').selectedOptions).map(opt => opt.value);
            
            // Calculate total cases
            let totalCases = 0;
            for (const [key, data] of Object.entries(selectedDemographics)) {
                if (data.selected && data.names.length > 0) {
                    // Each demographic creates test cases based on combinations
                    totalCases += data.names.length * 2; // 2 experience levels per name
                }
            }
            
            const totalPrompts = totalCases * iterations * models.length;
            
            const display = document.getElementById('calculation-display');
            display.innerHTML = `
                <div><strong>Demographics:</strong> ${Object.keys(selectedDemographics).length} selected</div>
                <div><strong>Base Cases:</strong> ${totalCases} (names × variations)</div>
                <div><strong>Iterations:</strong> ${iterations} per model</div>
                <div><strong>Models:</strong> ${models.length} selected</div>
                <div style="margin-top: 10px; font-size: 16px; color: #007bff;"><strong>Total Prompts:</strong> ${totalPrompts}</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">${totalCases} cases × ${iterations} iterations × ${models.length} models = ${totalPrompts} total</div>
            `;
        }
        
        function previewExperiment() {
            const config = {
                role: document.getElementById('role').value,
                iterations: parseInt(document.getElementById('iterations').value),
                models: Array.from(document.getElementById('models').selectedOptions).map(opt => opt.value),
                demographics: getSelectedDemographics(),
                prompt_template: document.getElementById('prompt-template').value,
                cv_level: document.querySelector('input[name="cv-level"]:checked').value
            };
            
            fetch('/api/preview-experiment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                displayPreview(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error previewing experiment');
            });
        }
        
        function displayPreview(data) {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            
            let html = `
                <div class="preview-card">
                    <h3>Experiment Overview</h3>
                    <p><strong>Total Demographics:</strong> ${data.total_demographics || 0}</p>
                    <p><strong>Base Cases:</strong> ${data.total_base_cases || 0}</p>
                    <p><strong>Total Prompts:</strong> ${data.total_prompts || 0}</p>
                    <p><strong>Calculation:</strong> ${data.calculation || 'N/A'}</p>
                </div>
                <div class="preview-card">
                    <h3>Prompt Template</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; font-family: monospace; font-size: 14px; line-height: 1.4; white-space: pre-wrap;">${document.getElementById('prompt-template').value}</div>
                    <small style="color: #666; margin-top: 10px; display: block;">This template will be used for all test cases with variables replaced per demographic group.</small>
                </div>
            `;
            
            if (data.test_groups && data.test_groups.length > 0) {
                html += '<div class="preview-card"><h3>Test Groups</h3>';
                data.test_groups.forEach((group, index) => {
                    html += `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>Group ${group.group_id + 1}:</strong> ${group.demographic}<br>
                            <strong>Cases:</strong> ${group.total_cases}<br>
                            <strong>Variables:</strong> ${JSON.stringify(group.variables)}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (data.sample_prompts && data.sample_prompts.length > 0) {
                html += '<div class="preview-card"><h3>Sample Prompts</h3>';
                
                data.sample_prompts.forEach((prompt, index) => {
                    let highlightedPrompt = prompt.prompt;
                    
                    // Highlight the variable (name)
                    if (prompt.variables.name) {
                        highlightedPrompt = highlightedPrompt.replace(
                            new RegExp(prompt.variables.name, 'g'),
                            `<span class="variable-highlight">${prompt.variables.name}</span>`
                        );
                    }
                    
                    html += `
                        <div class="prompt-preview">
                            <strong>Group ${prompt.group_id + 1}, Case ${prompt.case_id + 1}:</strong><br>
                            <strong>Variables:</strong> ${JSON.stringify(prompt.variables)}<br><br>
                            ${highlightedPrompt}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            previewContent.innerHTML = html;
            previewSection.style.display = 'block';
        }
        
        function startExperiment() {
            const config = {
                role: document.getElementById('role').value,
                iterations: parseInt(document.getElementById('iterations').value),
                models: Array.from(document.getElementById('models').selectedOptions).map(opt => opt.value),
                demographics: getSelectedDemographics(),
                prompt_template: document.getElementById('prompt-template').value,
                cv_level: document.querySelector('input[name="cv-level"]:checked').value
            };
            
            // Validate configuration
            if (Object.keys(config.demographics).length === 0) {
                alert('Please select at least one demographic group');
                return;
            }
            
            if (config.models.length === 0) {
                alert('Please select at least one model');
                return;
            }
            
            // Reset state
            totalResponses = 0;
            biasStats = null;
            document.getElementById('total-responses').textContent = '0';
            document.getElementById('current-bias-gap').textContent = '0%';
            document.getElementById('models-tested').textContent = config.models.length;
            document.getElementById('experiment-duration').textContent = '0s';
            document.getElementById('responses-content').innerHTML = '<p style="color: #666; font-style: italic;">Responses will appear here...</p>';
            document.getElementById('bias-alert').innerHTML = '';
            
            socket.emit('start_experiment', { config: config });
        }
        
        function stopExperiment() {
            if (currentExperiment) {
                socket.emit('stop_experiment', { experiment_id: currentExperiment });
                document.getElementById('stop-experiment').disabled = true;
                document.getElementById('stop-experiment').textContent = 'Stopping...';
            }
        }
        
        // History management variables
        let currentHistoryPage = 1;
        let historyPageSize = 20;
        let totalHistoryResponses = 0;
        let currentExperimentId = null;
        
        // Tab management
        function showResponseTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.response-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-responses-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load history if switching to history tab
            if (tabName === 'history' && currentExperimentId) {
                loadHistory();
            }
        }
        
        // Load experiment list
        function loadExperimentList() {
            fetch('/api/list-experiments')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('experiment-selector');
                    const currentValue = selector.value;
                    
                    let options = '<option value="">Select an experiment...</option>';
                    
                    if (data.experiments && data.experiments.length > 0) {
                        data.experiments.forEach(exp => {
                            const startTime = exp.start_time ? new Date(exp.start_time).toLocaleString() : 'Unknown';
                            const status = exp.status || 'unknown';
                            const responseCount = exp.response_count || 0;
                            const role = exp.config?.role || 'unknown';
                            
                            options += `<option value="${exp.experiment_id}">
                                ${exp.experiment_id} - ${role} (${responseCount} responses) - ${startTime} [${status}]
                            </option>`;
                        });
                    }
                    
                    selector.innerHTML = options;
                    
                    // Restore selection if it still exists
                    if (currentValue) {
                        selector.value = currentValue;
                    }
                    
                    // If there's a current experiment, select it
                    if (currentExperimentId && !currentValue) {
                        selector.value = currentExperimentId;
                    }
                })
                .catch(error => {
                    console.error('Error loading experiments:', error);
                });
        }
        
        // Load selected experiment
        function loadSelectedExperiment() {
            const selector = document.getElementById('experiment-selector');
            currentExperimentId = selector.value;
            
            if (currentExperimentId) {
                // Reset pagination
                currentHistoryPage = 1;
                loadHistory();
            } else {
                // Clear history display
                document.getElementById('history-content').innerHTML = 
                    '<p style="color: #666; font-style: italic;">Select an experiment to view its history...</p>';
            }
        }
        
        // Load experiment history
        function loadHistory(page = 1) {
            if (!currentExperimentId) return;
            
            const offset = (page - 1) * historyPageSize;
            const query = document.getElementById('history-search').value;
            const model = document.getElementById('history-model-filter').value;
            const decision = document.getElementById('history-decision-filter').value;
            
            let url = `/api/experiment-history/${currentExperimentId}?limit=${historyPageSize}&offset=${offset}`;
            
            if (query) url += `&query=${encodeURIComponent(query)}`;
            if (model) url += `&model=${encodeURIComponent(model)}`;
            if (decision) url += `&decision=${encodeURIComponent(decision)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('history-content').innerHTML = `<p style="color: red;">Error loading history: ${data.error}</p>`;
                        return;
                    }
                    
                    totalHistoryResponses = data.total_count;
                    currentHistoryPage = page;
                    
                    displayHistoryResponses(data.responses);
                    updateHistoryPagination();
                    updateHistoryModelFilter(data.responses);
                })
                .catch(error => {
                    document.getElementById('history-content').innerHTML = `<p style="color: red;">Error loading history: ${error}</p>`;
                });
        }
        
        // Display history responses
        function displayHistoryResponses(responses) {
            const historyContent = document.getElementById('history-content');
            
            if (!responses || responses.length === 0) {
                historyContent.innerHTML = '<p style="color: #666; font-style: italic;">No responses found.</p>';
                return;
            }
            
            let html = '';
            
            responses.forEach((response, index) => {
                const timestamp = new Date(response.timestamp).toLocaleString();
                const candidateName = response.metadata?.variables?.name || 'Unknown';
                
                // Determine response class and decision
                let responseClass = '';
                let decision = 'unclear';
                if (response.response.includes('HIRING DECISION: YES')) {
                    responseClass = 'yes';
                    decision = 'YES';
                } else if (response.response.includes('HIRING DECISION: NO')) {
                    responseClass = 'no';
                    decision = 'NO';
                }
                
                // Extract reasoning
                let reasoning = '';
                if (response.response.includes('REASONING:')) {
                    reasoning = response.response.split('REASONING:')[1].trim();
                }
                
                html += `
                    <div class="history-response-item ${responseClass}">
                        <div class="history-response-header">
                            <span>${response.model_name} → ${candidateName} → ${decision}</span>
                            <span class="history-response-timestamp">${timestamp}</span>
                        </div>
                        <div class="history-response-text">
                            ${reasoning || response.response}
                        </div>
                        <button class="history-prompt-toggle" onclick="toggleHistoryPrompt(${index})">
                            Show Prompt
                        </button>
                        <div class="history-prompt-content" id="history-prompt-${index}">
                            ${response.prompt || 'No prompt available'}
                        </div>
                    </div>
                `;
            });
            
            historyContent.innerHTML = html;
        }
        
        // Toggle prompt visibility
        function toggleHistoryPrompt(index) {
            const promptContent = document.getElementById(`history-prompt-${index}`);
            const button = event.target;
            
            if (promptContent.classList.contains('show')) {
                promptContent.classList.remove('show');
                button.textContent = 'Show Prompt';
            } else {
                promptContent.classList.add('show');
                button.textContent = 'Hide Prompt';
            }
        }
        
        // Update history pagination
        function updateHistoryPagination() {
            const totalPages = Math.ceil(totalHistoryResponses / historyPageSize);
            
            document.getElementById('history-info').textContent = 
                `Page ${currentHistoryPage} of ${totalPages} (${totalHistoryResponses} responses)`;
            
            document.getElementById('history-prev').disabled = currentHistoryPage <= 1;
            document.getElementById('history-next').disabled = currentHistoryPage >= totalPages;
        }
        
        // Update model filter options
        function updateHistoryModelFilter(responses) {
            const modelSelect = document.getElementById('history-model-filter');
            const currentValue = modelSelect.value;
            
            // Get unique models
            const models = [...new Set(responses.map(r => r.model_name))];
            
            // Update options
            const options = '<option value="">All Models</option>' + 
                models.map(model => `<option value="${model}">${model}</option>`).join('');
            
            modelSelect.innerHTML = options;
            
            // Restore selection if it still exists
            if (models.includes(currentValue)) {
                modelSelect.value = currentValue;
            }
        }
        
        // Load history page
        function loadHistoryPage(direction) {
            const newPage = currentHistoryPage + direction;
            if (newPage >= 1 && newPage <= Math.ceil(totalHistoryResponses / historyPageSize)) {
                loadHistory(newPage);
            }
        }
        
        // Search history
        function searchHistory() {
            currentHistoryPage = 1;
            loadHistory();
        }
        
        // Clear history search
        function clearHistorySearch() {
            document.getElementById('history-search').value = '';
            document.getElementById('history-model-filter').value = '';
            document.getElementById('history-decision-filter').value = '';
            searchHistory();
        }
        
        // Auto-load demographics and prompt on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDemographics();
            loadDefaultPrompt();
            loadExperimentList();
            
            // Add event listeners for real-time updates
            document.getElementById('iterations').addEventListener('input', updateExperimentSize);
            document.getElementById('models').addEventListener('change', updateExperimentSize);
            document.getElementById('role').addEventListener('change', updateExperimentSize);
            document.getElementById('prompt-template').addEventListener('input', updateExperimentSize);
        });
    </script>
</body>
</html>